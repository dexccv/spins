<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Spin Gacha</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; }
        
        body {
            background: #f5f7fa;
            color: #333;
            padding: 20px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.05);
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            border-bottom: 2px solid #f0f0f0;
            padding-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        h1 { color: #333; font-size: 1.8rem; }

        .refresh-btn {
            background: #00C4CC;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
        }

        .refresh-btn:hover { background: #00b3b9; }

        .search-input {
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            outline: none;
            width: 250px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        th {
            background-color: #f9f9f9;
            font-weight: 600;
            color: #555;
        }

        tr:hover { background-color: #f0f8ff; }

        .badge {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .badge-zonk { background: #eee; color: #666; }
        .badge-win { background: #e6fffa; color: #00cc66; border: 1px solid #00cc66; }

        .loading { text-align: center; padding: 20px; color: #888; }

        @media (max-width: 600px) {
            th, td { font-size: 0.9rem; padding: 10px; }
            .hide-mobile { display: none; }
        }

        .delete-btn {
            background: #ff4444;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: 0.2s;
        }

        .delete-btn:hover { background: #cc0000; }
    </style>
</head>
<body>

    <div class="container">
        <header>
            <div>
                <h1>Admin Dashboard</h1>
                <div id="dbStatus" style="font-size: 0.9rem; color: #666; margin-top: 5px; display: flex; align-items: center;">
                    <span style="display: inline-block; width: 10px; height: 10px; background: #ccc; border-radius: 50%; margin-right: 8px;"></span>
                    Menunggu Login...
                </div>
            </div>
            <div style="display: flex; gap: 10px;">
                <input type="text" id="searchInput" class="search-input" placeholder="Cari Nomor WA..." onkeyup="filterTable()">
                <button class="refresh-btn" onclick="fetchLogs()">Refresh Data</button>
            </div>
        </header>

        <!-- Login Overlay -->
        <div id="loginOverlay" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(245, 247, 250, 0.95); z-index: 9999; display: flex; justify-content: center; align-items: center; backdrop-filter: blur(5px);">
            <div style="background: white; padding: 40px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); text-align: center; max-width: 400px; width: 90%; border: 1px solid #eee;">
                <h2 style="margin-bottom: 20px; color: #333;">Login Admin</h2>
                <input type="password" id="adminPassword" placeholder="Masukkan Password" style="width: 100%; padding: 15px; margin-bottom: 20px; border: 1px solid #ddd; border-radius: 8px; outline: none; font-size: 1rem;">
                <button onclick="handleLogin()" style="background: #00C4CC; color: white; border: none; padding: 12px 30px; border-radius: 8px; cursor: pointer; font-weight: bold; width: 100%; font-size: 1rem; transition: 0.3s;">MASUK</button>
                <p id="loginError" style="color: #ff4444; margin-top: 15px; display: none; font-size: 0.9rem;">Password salah!</p>
            </div>
        </div>

        <div style="overflow-x: auto;">
            <table id="logsTable">
                <thead>
                    <tr>
                        <th>Waktu</th>
                        <th>Nomor WhatsApp</th>
                        <th>Hadiah</th>
                        <th class="hide-mobile">Keterangan</th>
                        <th>Aksi</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <tr><td colspan="4" class="loading">Memuat data...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // KONFIGURASI SUPABASE (SAMAKAN DENGAN INDEX.HTML)
        const supabaseUrl = 'https://wjhlwajgjarvlbwmsdgo.supabase.co';
        const supabaseKey = 'sb_publishable_o6xhcj9aKQNU3-b7UzU67A_7bQ3vZxZ';
        const supabase = supabase.createClient(supabaseUrl, supabaseKey);

        // Password sederhana (Ganti sesuai keinginan)
        const ADMIN_PASSWORD = 'admin'; 

        function handleLogin() {
            const input = document.getElementById('adminPassword').value;
            const errorMsg = document.getElementById('loginError');
            
            if (input === ADMIN_PASSWORD) {
                document.getElementById('loginOverlay').style.display = 'none';
                checkConnection();
                fetchLogs();
            } else {
                errorMsg.style.display = 'block';
                // Shake effect simple
                const inputEl = document.getElementById('adminPassword');
                inputEl.style.borderColor = '#ff4444';
                setTimeout(() => inputEl.style.borderColor = '#ddd', 500);
            }
        }

        async function checkConnection() {
            const statusEl = document.getElementById('dbStatus');
            statusEl.innerHTML = '<span style="display: inline-block; width: 10px; height: 10px; background: #ffd700; border-radius: 50%; margin-right: 8px;"></span> Memeriksa koneksi...';
            
            const { error } = await supabase.from('spin_logs').select('count', { count: 'exact', head: true });
            
            if (!error) {
                statusEl.innerHTML = '<span style="display: inline-block; width: 10px; height: 10px; background: #00cc66; border-radius: 50%; margin-right: 8px;"></span> Database Terhubung';
                statusEl.style.color = '#00cc66';
            } else {
                statusEl.innerHTML = `<span style="display: inline-block; width: 10px; height: 10px; background: #ff4444; border-radius: 50%; margin-right: 8px;"></span> Gagal Terhubung: ${error.message}`;
                statusEl.style.color = '#ff4444';
            }
        }

        async function fetchLogs() {
            const tableBody = document.getElementById('tableBody');
            tableBody.innerHTML = '<tr><td colspan="4" class="loading">Mengambil data terbaru...</td></tr>';

            // Ambil data dari tabel spin_logs, urutkan dari yang terbaru
            const { data, error } = await supabase
                .from('spin_logs')
                .select('*')
                .order('created_at', { ascending: false });

            if (error) {
                tableBody.innerHTML = `<tr><td colspan="4" style="color:red; text-align:center;">Error: ${error.message}</td></tr>`;
                return;
            }

            if (data.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="4" class="loading">Belum ada data spin.</td></tr>';
                return;
            }

            let html = '';
            data.forEach(log => {
                // Format Tanggal
                const date = new Date(log.created_at).toLocaleString('id-ID', {
                    day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit'
                });

                // Cek apakah Zonk atau Menang untuk styling
                const isZonk = log.prize_name.toLowerCase().includes('coba lagi');
                const badgeClass = isZonk ? 'badge-zonk' : 'badge-win';

                html += `
                    <tr>
                        <td>${date}</td>
                        <td style="font-weight:bold;">${log.phone_number}</td>
                        <td><span class="badge ${badgeClass}">${log.prize_name}</span></td>
                        <td class="hide-mobile" style="color:#666; font-size:0.9rem;">${log.prize_desc || '-'}</td>
                        <td><button class="delete-btn" onclick="deleteLog(${log.id})">Hapus</button></td>
                    </tr>
                `;
            });

            tableBody.innerHTML = html;
        }

        async function deleteLog(id) {
            if (!confirm('Apakah Anda yakin ingin menghapus data ini? Data yang dihapus tidak bisa dikembalikan.')) return;

            const { error } = await supabase
                .from('spin_logs')
                .delete()
                .eq('id', id);

            if (error) {
                alert('Gagal menghapus: ' + error.message);
            } else {
                fetchLogs(); // Refresh data tabel
            }
        }

        function filterTable() {
            const input = document.getElementById('searchInput');
            const filter = input.value.toLowerCase();
            const table = document.getElementById('logsTable');
            const tr = table.getElementsByTagName('tr');

            // Loop semua baris tabel, sembunyikan yang tidak cocok dengan pencarian
            for (let i = 1; i < tr.length; i++) { // Mulai dari 1 untuk melewati header
                const td = tr[i].getElementsByTagName('td')[1]; // Kolom ke-2 adalah Nomor WA
                if (td) {
                    const txtValue = td.textContent || td.innerText;
                    if (txtValue.toLowerCase().indexOf(filter) > -1) {
                        tr[i].style.display = "";
                    } else {
                        tr[i].style.display = "none";
                    }
                }
            }
        }

        // Load data saat halaman dibuka
        // window.onload = fetchLogs; // Diganti dengan login
        
        // Enter key untuk login
        document.getElementById('adminPassword').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') handleLogin();
        });
    </script>
</body>

</html>
