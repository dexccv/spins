<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spin Gacha - Dapatkan Aplikasi Premium</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;900&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }

        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            color: #333;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 30px;
        }

        header {
            text-align: center;
            padding: 20px;
            width: 100%;
        }

        h1 {
            font-size: 3.5rem;
            font-weight: 900;
            margin-bottom: 10px;
            background: linear-gradient(to right, #FFD700, #FFA500, #FF4500);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            text-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
            letter-spacing: -1px;
        }

        .subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
            max-width: 800px;
            margin: 0 auto;
            line-height: 1.6;
        }

        .main-content {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 40px;
            width: 100%;
        }

        .wheel-section {
            flex: 1;
            min-width: 300px;
            max-width: 600px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .wheel-container {
            position: relative;
            width: 100%;
            max-width: 500px;
            margin: 0 auto;
        }

        .wheel {
            width: 100%;
            height: 100%;
            aspect-ratio: 1;
            border-radius: 50%;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.1), inset 0 0 30px rgba(0,0,0,0.2);
            border: 10px solid rgba(255, 255, 255, 0.8);
            position: relative;
            overflow: hidden;
        }

        .wheel-item {
            position: absolute;
            top: 0;
            left: 50%;
            height: 50%;
            width: 60px;
            transform-origin: bottom center;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding-top: 12%;
            z-index: 2;
            pointer-events: none;
        }

        .wheel-item img {
            width: 45px;
            height: 45px;
            object-fit: contain;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
            transform: rotate(0deg);
        }

        .wheel-item i {
            font-size: 32px;
            color: rgba(255,255,255,0.95);
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
        }

        .wheel-center {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 70px;
            height: 70px;
            background: radial-gradient(circle, #fff, #f0f0f0);
            border-radius: 50%;
            border: 4px solid #FFD700;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.6);
            z-index: 10;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #333;
            font-weight: bold;
            font-size: 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .wheel-center:hover {
            transform: translate(-50%, -50%) scale(1.1);
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.8);
        }

        .wheel-center.spinning {
            animation: pulse 1s infinite;
        }

        .pointer {
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            width: 50px;
            height: auto;
            z-index: 5;
            filter: drop-shadow(0 5px 10px rgba(0, 0, 0, 0.5));
        }

        .controls {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 30px;
            width: 100%;
            max-width: 500px;
        }

        .spin-button {
            background: linear-gradient(45deg, #FFD700, #FF8C00);
            color: white;
            border: none;
            padding: 18px 40px;
            font-size: 1.5rem;
            font-weight: bold;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 10px 25px rgba(255, 140, 0, 0.4);
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .spin-button:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(255, 140, 0, 0.6);
        }

        .spin-button:disabled {
            background: linear-gradient(90deg, #666, #888);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .spin-count {
            font-size: 1.2rem;
            text-align: center;
            background: rgba(255, 255, 255, 0.8);
            color: #333;
            padding: 10px 20px;
            border-radius: 50px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(0,0,0,0.1);
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }

        .prizes-section {
            flex: 1;
            min-width: 300px;
            max-width: 500px;
        }

        .prizes-title {
            font-size: 2rem;
            margin-bottom: 20px;
            text-align: center;
            color: #e67e22;
        }

        .prizes-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .prize-item {
            background: #ffffff;
            border-radius: 20px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            transition: all 0.3s ease;
            border: 1px solid rgba(0, 0, 0, 0.05);
            box-shadow: 0 10px 20px rgba(0,0,0,0.05);
            color: #333;
        }

        .prize-item:hover {
            transform: translateY(-10px);
            border-color: #ffcc00;
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.1);
        }

        .prize-icon {
            font-size: 2.5rem;
            margin-bottom: 10px;
            color: #e67e22;
        }

        .prize-icon img {
            width: 60px;
            height: 60px;
            object-fit: contain;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
        }

        .prize-name {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .result-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 2000;
            display: none;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(8px);
        }

        .result-overlay.show {
            display: flex;
            animation: fadeIn 0.3s ease;
        }

        .result-container {
            background: #ffffff;
            border-radius: 20px;
            padding: 25px;
            text-align: center;
            border: 2px solid rgba(255, 204, 0, 0.3);
            max-width: 90%;
            width: 380px;
            position: relative;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.1);
            color: #333;
        }

        .result-title {
            font-size: 1.5rem;
            margin-bottom: 15px;
            color: #e67e22;
        }

        .result-prize {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .result-icon {
            font-size: 3rem;
            color: #ffcc00;
        }

        .result-name {
            font-size: 1.5rem;
            font-weight: bold;
        }

        .result-description {
            font-size: 0.9rem;
            line-height: 1.5;
            max-width: 600px;
            margin: 0 auto 20px;
            color: #666;
        }

        .claim-button {
            background: linear-gradient(90deg, #00cc66, #00b359);
            color: white;
            border: none;
            padding: 12px 30px;
            font-size: 1rem;
            font-weight: bold;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 10px 20px rgba(0, 204, 102, 0.3);
        }

        .claim-button:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0, 204, 102, 0.4);
        }

        .close-modal {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            color: rgba(0, 0, 0, 0.3);
            font-size: 1.5rem;
            cursor: pointer;
            transition: 0.3s;
        }

        .close-modal:hover {
            color: #000;
            transform: rotate(90deg);
        }

        .settings-panel {
            width: 100%;
            max-width: 800px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            padding: 25px;
            margin-top: 30px;
            border: 2px solid rgba(255, 204, 0, 0.2);
            display: none;
        }

        .settings-title {
            font-size: 1.8rem;
            margin-bottom: 20px;
            color: #ffcc00;
            text-align: center;
        }

        .probability-controls {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .probability-item {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .probability-label {
            display: flex;
            justify-content: space-between;
        }

        .probability-name {
            font-weight: bold;
        }

        .probability-value {
            color: #ffcc00;
            font-weight: bold;
        }

        .probability-slider {
            width: 100%;
            height: 10px;
            -webkit-appearance: none;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            outline: none;
        }

        .probability-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: #ffcc00;
            cursor: pointer;
            box-shadow: 0 0 10px rgba(255, 204, 0, 0.8);
        }

        .reset-button {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 2px solid #ffcc00;
            padding: 12px 30px;
            font-size: 1.1rem;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: block;
            margin: 0 auto;
        }

        .reset-button:hover {
            background: rgba(255, 204, 0, 0.2);
        }

        footer {
            margin-top: 40px;
            text-align: center;
            opacity: 0.7;
            font-size: 0.9rem;
            padding: 20px;
            width: 100%;
        }

        @keyframes pulse {
            0% { transform: translate(-50%, -50%) scale(1); }
            50% { transform: translate(-50%, -50%) scale(1.1); }
            100% { transform: translate(-50%, -50%) scale(1); }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @media (max-width: 768px) {
            body {
                padding: 15px;
            }

            h1 {
                font-size: 2rem;
            }
            
            .subtitle {
                font-size: 1rem;
            }

            .main-content {
                flex-direction: column;
                align-items: center;
                gap: 30px;
            }
            
            .wheel-section {
                width: 100%;
            }
            
            .wheel-container {
                max-width: 320px;
                width: 90vw;
            }
            
            .wheel-center {
                width: 60px;
                height: 60px;
                font-size: 1.2rem;
            }

            .pointer {
                width: 40px;
                top: -20px;
            }
            
            .spin-button {
                padding: 15px 35px;
                font-size: 1.3rem;
            }

            .prizes-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }

            .prize-item {
                padding: 15px;
            }
            
            .result-name {
                font-size: 1.3rem;
            }
            
            .result-icon {
                font-size: 2.5rem;
            }
        }

        /* Styles for Login Modal */
        .login-input {
            width: 100%;
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #ddd;
            background: #f0f0f0;
            color: #333;
            font-size: 1.1rem;
            margin: 20px 0;
            outline: none;
            text-align: center;
        }
        
        .login-input:focus {
            border-color: #ffcc00;
            background: #fff;
        }

        .login-button {
            background: linear-gradient(45deg, #FFD700, #FF8C00);
            color: white;
            border: none;
            padding: 12px 30px;
            font-size: 1.1rem;
            font-weight: bold;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            text-transform: uppercase;
        }

        .login-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(255, 140, 0, 0.4);
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-gift"></i> SPIN GACHA PREMIUM</h1>
            <p class="subtitle">Terima kasih telah berbelanja! Dapatkan <b>1x Spin Gratis</b> untuk setiap pembelian minimal <b>Rp 15.000</b>. Putar rodanya dan menangkan hadiah aplikasi premium spesial untukmu!</p>
        </header>

        <div class="main-content">
            <div class="wheel-section">
                <div class="wheel-container">
                    <div class="wheel" id="wheel"></div>
                    <div class="wheel-center" id="spinButton">
                        SPIN
                    </div>
                    <img src="https://cdn-icons-png.flaticon.com/512/5226/5226377.png" alt="Pointer" class="pointer">
                </div>

                <div class="controls">
                    <button class="spin-button" id="spinButtonBig">PUTAR RODA</button>
                    <div class="spin-count">Putaran tersisa: <span id="spinCount">3</span></div>
                </div>
            </div>

            <div class="prizes-section">
                <h2 class="prizes-title">Hadiah yang Tersedia</h2>
                <div class="prizes-grid" id="prizesGrid">
                    <!-- Prize items will be generated by JavaScript -->
                </div>
            </div>
        </div>

        <div class="settings-panel">
            <h2 class="settings-title">Pengaturan Persentase Kemenangan</h2>
            <p style="text-align: center; margin-bottom: 20px; opacity: 0.9;">Atur persentase kemenangan untuk setiap hadiah. Total harus 100%.</p>
            <div class="probability-controls" id="probabilityControls">
                <!-- Probability controls will be generated by JavaScript -->
            </div>
            <div style="text-align: center; margin-top: 20px;">
                <div style="margin-bottom: 15px; font-size: 1.2rem;">
                    Total: <span id="totalProbability" style="color: #ffcc00; font-weight: bold;">100</span>%
                </div>
                <button class="reset-button" id="resetButton">Reset ke Default</button>
            </div>
        </div>

        <footer>
            <p>¬© 2023 Spin Gacha Premium. Hadiah akan dikirimkan ke WhatsApp setelah verifikasi bukti pembelian.</p>
            <p style="margin-top: 10px;">Promo berlaku untuk setiap transaksi minimal Rp 15.000.</p>
        </footer>

        <div class="result-overlay" id="resultOverlay">
            <div class="result-container">
                <button class="close-modal" id="closeModal"><i class="fas fa-times"></i></button>
                <h2 class="result-title">SELAMAT!</h2>
                <div class="result-prize">
                    <div class="result-icon" id="resultIcon"></div>
                    <div class="result-name" id="resultName"></div>
                </div>
                <p class="result-description" id="resultDescription"></p>
                <button class="claim-button" id="claimButton">KLAIM HADIAH</button>
            </div>
        </div>

        <div class="result-overlay" id="loginOverlay">
            <div class="result-container" style="width: 350px;">
                <h2 class="result-title">VERIFIKASI PELANGGAN</h2>
                <p class="result-description">Masukkan nomor WhatsApp Anda untuk memulai. Pastikan Anda telah melakukan pembelian minimal <b>Rp 15.000</b> agar hadiah sah.</p>
                <input type="number" id="userPhoneInput" class="login-input" placeholder="Contoh: 08123456789">
                <button class="login-button" id="submitPhoneBtn">MULAI SPIN</button>
            </div>
        </div>

        <div class="result-overlay" id="notificationOverlay">
            <div class="result-container" style="width: 350px;">
                <h2 class="result-title" id="notifTitle">INFO</h2>
                <p class="result-description" id="notifMessage"></p>
                <button class="login-button" id="notifButton">OK</button>
            </div>
        </div>
    </div>

    <script>
        // Data hadiah dengan persentase default
        const prizes = [
            {
                id: 1,
                name: "CapCut Pro 7 Hari",
                
                image: "https://i.pinimg.com/736x/2b/eb/97/2beb978648a6c369964817db87bebb30.jpg",
                description: "Edit video tanpa watermark dengan fitur Pro selama 7 hari.",
                probability: 5,
                color: "#333333"
            },
            {
                id: 2,
                name: "Canva Pro 7 Hari",
                
                image: "https://i.pinimg.com/1200x/1f/36/31/1f3631835b7a892a075d8a84b0dcd429.jpg",
                description: "Akses Canva Pro via invite team selama 7 hari.",
                probability: 5,
                color: "#00C4CC"
            },
            {
                id: 3,
                name: "Canva Pro 1 Bulan",
                
                image: "https://i.pinimg.com/1200x/4a/bd/1b/4abd1bb47e59cefcd9c5e472c9705e52.jpg",
                description: "Desain tanpa batas dengan Canva Pro selama 1 bulan penuh.",
                probability: 5,
                color: "#8B3DFF"
            },
            {
                id: 4,
                name: "CapCut Pro +5 Hari",
                
                image: "https://i.pinimg.com/736x/2b/eb/97/2beb978648a6c369964817db87bebb30.jpg",
                description: "Bonus tambahan durasi CapCut Pro selama 5 hari.",
                probability: 5,
                color: "#333333"
            },
            {
                id: 5,
                name: "Viu Premium 1 Bulan",
                
                image: "https://i.pinimg.com/736x/fe/cc/dc/feccdc6f17cc46f82c01f0f6a37cb0c1.jpg",
                description: "Nonton drama Korea dan Asia bebas iklan selama 1 bulan.",
                probability: 5,
                color: "#F4B400"
            },
            {
                id: 6,
                name: "Coba Lagi",
                
                image: "https://st2.depositphotos.com/1575949/7817/v/450/depositphotos_78175820-stock-illustration-try-again-red-stamp-text.jpg",
                description: "Yah, belum beruntung. Silakan coba putar lagi!",
                probability: 25, // 25%
                color: "#555555"
            }
        ];

        // Elemen DOM
        const wheel = document.getElementById('wheel');
        const spinButton = document.getElementById('spinButton');
        const spinButtonBig = document.getElementById('spinButtonBig');
        const spinCountElement = document.getElementById('spinCount');
        const prizesGrid = document.getElementById('prizesGrid');
        const resultOverlay = document.getElementById('resultOverlay');
        const closeModal = document.getElementById('closeModal');
        const resultIcon = document.getElementById('resultIcon');
        const resultName = document.getElementById('resultName');
        const resultDescription = document.getElementById('resultDescription');
        const claimButton = document.getElementById('claimButton');
        const probabilityControls = document.getElementById('probabilityControls');
        const totalProbabilityElement = document.getElementById('totalProbability');
        const resetButton = document.getElementById('resetButton');
        const loginOverlay = document.getElementById('loginOverlay');
        const userPhoneInput = document.getElementById('userPhoneInput');
        const submitPhoneBtn = document.getElementById('submitPhoneBtn');
        const notificationOverlay = document.getElementById('notificationOverlay');
        const notifTitle = document.getElementById('notifTitle');
        const notifMessage = document.getElementById('notifMessage');
        const notifButton = document.getElementById('notifButton');

        // KONFIGURASI SUPABASE
        const supabaseUrl = 'MASUKKAN_SUPABASE_URL_ANDA';
        const supabaseKey = 'MASUKKAN_SUPABASE_ANON_KEY_ANDA';
        const supabase = supabase.createClient(supabaseUrl, supabaseKey);

        // Variabel state
        let spinCount = 1;
        let isSpinning = false;
        let currentProbabilities = [...prizes.map(prize => prize.probability)];
        let totalProbability = currentProbabilities.reduce((a, b) => a + b, 0);
        let currentRotation = 0; // Menyimpan posisi rotasi saat ini
        let lastWonPrize = null;
        let userPhoneNumber = "";
        let countdownInterval;
        const COOLDOWN_TIME = 3 * 60 * 60 * 1000; // 3 Jam

        // Inisialisasi
        function init() {
            renderPrizes();
            renderProbabilityControls();
            checkCooldown();
            renderWheel();
        }

        // Render daftar hadiah
        function renderPrizes() {
            prizesGrid.innerHTML = '';
            
            prizes.forEach((prize, index) => {
                const prizeElement = document.createElement('div');
                prizeElement.className = 'prize-item';
                
                const iconContent = prize.image ? `<img src="${prize.image}" alt="${prize.name}">` : `<i class="${prize.icon}"></i>`;
                
                prizeElement.innerHTML = `
                    <div class="prize-icon" style="color: ${prize.color}">
                        <i class="${prize.icon}"></i>
                        ${iconContent}
                    </div>
                    <div class="prize-name">${prize.name}</div>
                `;
                
                prizesGrid.appendChild(prizeElement);
            });
        }

        // Render Roda secara dinamis
        function renderWheel() {
            const segmentAngle = 360 / prizes.length;
            let gradient = 'conic-gradient(';
            
            // Bersihkan elemen anak (icon/gambar) sebelum render ulang
            wheel.innerHTML = '';
            
            prizes.forEach((prize, index) => {
                const start = index * segmentAngle;
                const end = (index + 1) * segmentAngle;
                gradient += `${prize.color} ${start}deg ${end}deg,`;
                
                // Tambahkan gambar/icon ke roda
                const segmentCenterAngle = start + (segmentAngle / 2);
                const item = document.createElement('div');
                item.className = 'wheel-item';
                item.style.transform = `translateX(-50%) rotate(${segmentCenterAngle}deg)`;
                
                if (prize.image && prize.image.trim() !== "") {
                    item.innerHTML = `<img src="${prize.image}" alt="${prize.name}">`;
                } else {
                    item.innerHTML = `<i class="${prize.icon}"></i>`;
                }
                
                wheel.appendChild(item);
            });
            
            gradient = gradient.slice(0, -1) + ')';
            wheel.style.background = gradient;
        }

        // Cek waktu cooldown
        function checkCooldown() {
            const lastSpinTime = localStorage.getItem('lastSpinTime');
            if (lastSpinTime) {
                const elapsed = Date.now() - parseInt(lastSpinTime);
                if (elapsed < COOLDOWN_TIME) {
                    spinCount = 0;
                    startCountdown(parseInt(lastSpinTime) + COOLDOWN_TIME);
                } else {
                    spinCount = 1;
                    updateSpinCount();
                }
            } else {
                spinCount = 1;
                updateSpinCount();
            }
        }

        // Mulai hitung mundur
        function startCountdown(endTime) {
            const spinCountContainer = document.querySelector('.spin-count');
            
            if (countdownInterval) clearInterval(countdownInterval);
            
            function updateTimer() {
                const now = Date.now();
                const distance = endTime - now;
                
                if (distance < 0) {
                    clearInterval(countdownInterval);
                    localStorage.removeItem('lastSpinTime');
                    window.location.reload(); // Reload untuk reset state
                    return;
                }
                
                const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((distance % (1000 * 60)) / 1000);
                
                spinCountContainer.innerHTML = `Tunggu: ${hours}j ${minutes}m ${seconds}d`;
                
                if (spinButton) {
                    spinButton.disabled = true;
                    spinButton.textContent = "WAIT";
                }
                if (spinButtonBig) {
                    spinButtonBig.disabled = true;
                    spinButtonBig.textContent = "MENUNGGU...";
                }
            }
            
            updateTimer();
            countdownInterval = setInterval(updateTimer, 1000);
        }

        // Render kontrol persentase
        function renderProbabilityControls() {
            probabilityControls.innerHTML = '';
            
            prizes.forEach((prize, index) => {
                const controlElement = document.createElement('div');
                controlElement.className = 'probability-item';
                controlElement.innerHTML = `
                    <div class="probability-label">
                        <span class="probability-name">${prize.name}</span>
                        <span class="probability-value" id="probValue${index}">${currentProbabilities[index]}%</span>
                    </div>
                    <input type="range" min="0" max="100" value="${currentProbabilities[index]}" 
                           class="probability-slider" data-index="${index}"
                           style="background: linear-gradient(90deg, ${prize.color} ${currentProbabilities[index]}%, rgba(255,255,255,0.1) ${currentProbabilities[index]}%)">
                `;
                
                probabilityControls.appendChild(controlElement);
            });
            
            // Tambahkan event listener untuk slider
            document.querySelectorAll('.probability-slider').forEach(slider => {
                slider.addEventListener('input', function() {
                    const index = parseInt(this.dataset.index);
                    const value = parseInt(this.value);
                    
                    // Update nilai probabilitas
                    currentProbabilities[index] = value;
                    
                    // Update tampilan
                    document.getElementById(`probValue${index}`).textContent = `${value}%`;
                    this.style.background = `linear-gradient(90deg, ${prizes[index].color} ${value}%, rgba(255,255,255,0.1) ${value}%)`;
                    
                    // Update total
                    updateTotalProbability();
                    renderWheel(); // Update roda jika warna/data berubah (opsional)
                });
            });
            
            updateTotalProbability();
        }

        // Update total persentase
        function updateTotalProbability() {
            totalProbability = currentProbabilities.reduce((a, b) => a + b, 0);
            totalProbabilityElement.textContent = totalProbability;
            
            // Update persentase di daftar hadiah
            document.querySelectorAll('.prize-probability').forEach((el, index) => {
                el.textContent = `${currentProbabilities[index]}%`;
            });
        }

        // Update jumlah putaran tersisa
        function updateSpinCount() {
            const el = document.getElementById('spinCount');
            if (el) el.textContent = spinCount;
            
            // Nonaktifkan tombol spin jika tidak ada putaran tersisa
            if (spinCount <= 0) {
                spinButton.disabled = true;
                spinButtonBig.disabled = true;
                spinButtonBig.textContent = "PUTARAN HABIS";
                spinButton.textContent = "HABIS";
            } else {
                spinButton.disabled = false;
                spinButtonBig.disabled = false;
                spinButtonBig.textContent = "PUTAR RODA";
                spinButton.textContent = "SPIN";
            }
        }

        // Fungsi untuk memutar suara 'tik' menggunakan Web Audio API
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        
        function playTickSound() {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            osc.type = 'triangle';
            osc.frequency.setValueAtTime(600, audioCtx.currentTime);
            gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.00001, audioCtx.currentTime + 0.1);
            osc.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            osc.start();
            osc.stop(audioCtx.currentTime + 0.1);
        }

        // Putar roda
        function spinWheel() {
            // Cek apakah user sudah input nomor
            if (!userPhoneNumber) {
                loginOverlay.classList.add('show');
                return;
            }

            if (isSpinning || spinCount <= 0) return;
            
            // Kurangi jumlah putaran
            spinCount--;
            updateSpinCount();
            
            // Simpan waktu spin
            localStorage.setItem('lastSpinTime', Date.now());
            
            // Atur status spinning
            isSpinning = true;
            spinButton.classList.add('spinning');
            spinButtonBig.disabled = true;
            
            // Hitung hadiah berdasarkan probabilitas
            const winningPrize = getRandomPrize();
            
            // Hitung sudut putaran (3600¬∞ = 10 putaran penuh + sudut hadiah)
            const segments = prizes.length;
            const segmentAngle = 360 / segments;
            
            // Hitung sudut untuk hadiah yang menang
            // Kita ingin pointer (di atas/0 derajat) menunjuk ke tengah segmen hadiah
            const prizeIndex = prizes.findIndex(p => p.id === winningPrize.id);
            
            // Hitung target sudut absolut (0-360) dimana roda harus berhenti
            // Rumus: 360 - (Index * Segment) - (Segment/2)
            // Ini menempatkan tengah segmen di posisi 0 derajat (jam 12)
            const targetAngle = 360 - (prizeIndex * segmentAngle) - (segmentAngle / 2);
            
            // Hitung delta rotasi yang dibutuhkan dari posisi sekarang
            // Pastikan putaran selalu positif (searah jarum jam)
            const currentMod = currentRotation % 360;
            let rotationNeeded = targetAngle - currentMod;
            
            if (rotationNeeded <= 0) {
                rotationNeeded += 360;
            }
            
            // Tambahkan putaran ekstra untuk efek visual (minimal 5 putaran)
            // Tambahkan sedikit variasi random di dalam segmen agar tidak selalu tepat di tengah
            const spins = 5;
            const randomOffset = (Math.random() - 0.5) * (segmentAngle * 0.4); // +/- 20% dari lebar segmen
            const totalRotation = currentRotation + rotationNeeded + (spins * 360) + randomOffset;
            
            // Animasi JS manual untuk kontrol suara dan easing
            const duration = 6000; // 6 detik (lebih lama untuk suspense)
            const startTime = performance.now();
            const startRotation = currentRotation;
            let lastSegmentIndex = Math.floor(startRotation / segmentAngle);

            function animate(currentTime) {
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);
                
                // Easing function: Ease Out Quart (cepat di awal, melambat dramatis di akhir)
                const ease = 1 - Math.pow(1 - progress, 4);
                
                currentRotation = startRotation + (totalRotation - startRotation) * ease;
                wheel.style.transform = `rotate(${currentRotation}deg)`;
                
                // Cek untuk suara tik
                const currentSegmentIndex = Math.floor(currentRotation / segmentAngle);
                if (currentSegmentIndex > lastSegmentIndex) {
                    playTickSound();
                    lastSegmentIndex = currentSegmentIndex;
                }

                if (progress < 1) {
                    requestAnimationFrame(animate);
                } else {
                    isSpinning = false;
                    spinButton.classList.remove('spinning');
                    spinButtonBig.disabled = false;
                    showResult(winningPrize);
                }
            }
            
            requestAnimationFrame(animate);
        }

        // Dapatkan hadiah acak berdasarkan probabilitas
        function getRandomPrize() {
            // Normalisasikan probabilitas jika total tidak 100%
            const normalizedProbabilities = currentProbabilities.map(p => p / totalProbability * 100);
            
            // Buat array kumulatif
            const cumulativeProbabilities = [];
            let cumulative = 0;
            normalizedProbabilities.forEach(p => {
                cumulative += p;
                cumulativeProbabilities.push(cumulative);
            });
            
            // Hasilkan angka acak
            const random = Math.random() * 100;
            
            // Temukan hadiah yang sesuai
            for (let i = 0; i < cumulativeProbabilities.length; i++) {
                if (random <= cumulativeProbabilities[i]) {
                    return prizes[i];
                }
            }
            
            // Fallback ke hadiah terakhir
            return prizes[prizes.length - 1];
        }

        // Tampilkan hasil
        function showResult(prize) {
            lastWonPrize = prize;
            const resultTitle = document.querySelector('.result-title');
            resultIcon.innerHTML = `<i class="${prize.icon}"></i>`;
            
            if (prize.image) {
                resultIcon.innerHTML = `<img src="${prize.image}" alt="${prize.name}" style="width: 100px; height: 100px; object-fit: contain;">`;
            } else {
                resultIcon.innerHTML = `<i class="${prize.icon}"></i>`;
            }
            
            resultName.textContent = prize.name;
            resultDescription.textContent = prize.description;
            
            // Update warna berdasarkan hadiah
            resultIcon.style.color = prize.color;
            resultName.style.color = prize.color;
            
            // Cek jika hadiah adalah "Coba Lagi" (Zonk)
            if (prize.id === 6) {
                resultTitle.textContent = "YAHHH... BELUM BERUNTUNG";
                claimButton.textContent = "TUTUP";
                claimButton.style.background = "#666";
                claimButton.style.boxShadow = "none";
            } else {
                resultTitle.textContent = "SELAMAT!";
                claimButton.textContent = "KLAIM HADIAH";
                claimButton.style.background = ""; // Reset ke style CSS default
                claimButton.style.boxShadow = "";
            }
            
            // Tampilkan container hasil
            resultOverlay.classList.add('show');

            // SIMPAN KE SUPABASE
            saveToDatabase(userPhoneNumber, prize);
        }

        // Fungsi Simpan ke Database
        async function saveToDatabase(phone, prize) {
            const { error } = await supabase
                .from('spin_logs')
                .insert({ phone_number: phone, prize_name: prize.name, prize_desc: prize.description });
            
            if (error) console.error('Gagal menyimpan data:', error);
        }

        // Reset probabilitas ke default
        function resetProbabilities() {
            currentProbabilities = [...prizes.map(prize => prize.probability)];
            renderPrizes();
            renderProbabilityControls();
        }

        // Fungsi Custom Notification pengganti Alert
        function showNotification(title, message, buttonText = "OK", callback = null) {
            notifTitle.textContent = title;
            notifMessage.innerHTML = message;
            notifButton.textContent = buttonText;
            
            notifButton.onclick = function() {
                notificationOverlay.classList.remove('show');
                if (callback) callback();
            };
            
            notificationOverlay.classList.add('show');
        }

        // Handle Login/Input Nomor
        submitPhoneBtn.addEventListener('click', function() {
            const inputVal = userPhoneInput.value.trim();
            if (inputVal.length < 10) {
                showNotification("NOMOR TIDAK VALID", "Mohon masukkan nomor WhatsApp yang valid!", "COBA LAGI", () => {
                    userPhoneInput.focus();
                });
                return;
            }
            userPhoneNumber = inputVal;
            loginOverlay.classList.remove('show');
            spinWheel(); // Langsung putar otomatis
        });

        // Event Listeners
        spinButton.addEventListener('click', spinWheel);
        spinButtonBig.addEventListener('click', spinWheel);

        claimButton.addEventListener('click', function() {
            if (!lastWonPrize) return;
            
            // Jika Zonk/Coba Lagi, hanya tutup popup
            if (lastWonPrize.id === 6) {
                resultOverlay.classList.remove('show');
                return;
            }
            
            // Ubah teks tombol loading
            const originalText = claimButton.innerText;
            claimButton.innerText = "MEMPROSES...";
            claimButton.disabled = true;
            
            // Ambil screenshot area hasil menggunakan html2canvas
            html2canvas(document.querySelector(".result-container"), {
                scale: 2, // Kualitas gambar lebih tinggi
                backgroundColor: null,
                useCORS: true,
                // Gunakan onclone untuk menyembunyikan elemen HANYA di hasil screenshot
                // Tampilan asli tidak akan berubah/bergeser
                onclone: (clonedDoc) => {
                    const clonedClose = clonedDoc.getElementById('closeModal');
                    const clonedClaim = clonedDoc.getElementById('claimButton');
                    if (clonedClose) clonedClose.style.display = 'none';
                    if (clonedClaim) clonedClaim.style.display = 'none';
                }
            }).then(canvas => {
                // Kembalikan teks tombol (tidak perlu reset display karena DOM asli tidak disentuh)
                claimButton.innerText = originalText;
                claimButton.disabled = false;

                // Download gambar otomatis
                const link = document.createElement('a');
                link.download = `Bukti-Menang-${lastWonPrize.name.replace(/\s+/g, '-')}.png`;
                link.href = canvas.toDataURL("image/png");
                link.click();
                
                // Siapkan pesan WhatsApp
                const now = new Date();
                const timestamp = now.toLocaleString('id-ID', { 
                    dateStyle: 'full', 
                    timeStyle: 'medium' 
                });

                const phoneNumber = "6281225589199";
                const message = `Halo Admin, saya sudah belanja minimal 15k dan ingin klaim hadiah Spin Gacha.\n\n` +
                                `üë§ *Data Pemain:*\n` +
                                `Nomor WA: ${userPhoneNumber}\n\n` +
                                `üíå *Detail Hadiah:*\n` +
                                `Nama: ${lastWonPrize.name}\n` +
                                `Keterangan: ${lastWonPrize.description}\n` +
                                `Waktu Klaim: ${timestamp}\n\n` +
                                `*‚ö†Ô∏è PENTING: Bukti screenshot sudah saya lampirkan di chat ini.*`;
                
                const whatsappUrl = `https://wa.me/${phoneNumber}?text=${encodeURIComponent(message)}`;
                
                // Beri instruksi jelas ke user
                showNotification(
                    "DOWNLOAD BERHASIL", 
                    "Bukti kemenangan berhasil diunduh!<br><br>Silakan lampirkan (upload) gambar tersebut di chat WhatsApp yang akan terbuka.", 
                    "LANJUT KE WHATSAPP", 
                    () => {
                        window.open(whatsappUrl, '_blank');
                        resultOverlay.classList.remove('show');
                    }
                );
            });
        });

        closeModal.addEventListener('click', function() {
            resultOverlay.classList.remove('show');
        });

        resetButton.addEventListener('click', resetProbabilities);

        // Inisialisasi saat halaman dimuat
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>